---
title: "コミットに署名するとはどういうことなのか"
emoji: "✨"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: [git,github]
published: false
---

> 「私はこれを記述した、そしてこの仕事の後ろには私が付いている」と。品質の証明として、あなたの署名が入っているべきなのです。

## はじめに

コミットの署名に関して次の記事を書きました。

https://zenn.dev/yumemi_inc/articles/signed-commit

この記事では、署名の具体的な方法については触れません。署名の具体的な方法が知りたい場合は、上記記事中で紹介している GitHub のドキュメントが豊富なので、そちらを参照するとわかりやすいです。この記事では、署名をすることにどういった効果があるのか掘り下げています。読者がどういった署名を採用するかの判断基準が得られることを目標にします。

この記事の執筆にあたり GitHub 上でのコミットの見え方を検証するリポジトリを作成して公開しています。

https://github.com/ykws/signed-commit-example

## 用語の整理
### 署名/記名/落款

「あなたの作品に署名をする」

この言葉を聞いて作品とはどんなものをイメージしますか？
何か具体的なアプリケーションでしょうか、それとも、そのアプリを構成する一機能でしょうか
プログラマにとって1つのコミットが1つの作品という位置付けに共感できるでしょうか

仮に1つのコミットをあなたの一つの作品として、それに署名しましょう、という動機付けに共感できるでしょうか

結論は急ぎません。ここでは問いかけのみに留めます。

「署名」という言葉には次のような解釈があります。

> 「**署名**」とは、契約書などの文書に氏名を自書することをいいます。作成者によって署名がなされた文書は、その成立の真正が推定されます。これに対して「**記名**」は、氏名や名称などを印字することをいいます。署名とは異なり、記名には文書の成立の真正を推定される効力がないため、押印が併用されるケースが多いです。

https://keiyaku-watch.jp/media/kisochishiki/signature/

この解釈によると、コミットに名前やメールアドレスを設定することを署名と表現すると誤解が含まれそうです。どちらかと言えば記名です。コミットに記名する。この表現が適切だと感じました。さらにいうと落款のような判子として押印する行為がコミットに記名するメタファとしても近いです。なぜなら初期設定後に毎回記名することはなくて、コミット時に繰り返し自動で行われるからです。

https://zenzine.jp/write/calligraphy/11184/

### コード署名
GPG署名は公開鍵暗号化方式を採用しているのでコード署名になります。

https://e-words.jp/w/コード署名.html

## 署名の段階の整理
これらを踏まえて署名の段階の整理をします。
記事中のホストは GitHub に限定して書いています。他のホスティングサービスでも基本は同じと思います。

1. コミットに名前が設定されている
2. コミットにメールアドレスが設定されている
3. ホストにメールアドレスが登録されている
4. コミットにコード署名されている
5. ホストに公開鍵が登録されている

それぞれの段階で実際に GitHub 上でどのように見えるかはリポジトリのコミット履歴を見てもらうとわかりやすいです。

Git の公式ドキュメントでは、最初にやることが名前とメールアドレスを設定することと記されています。

https://git-scm.com/book/en/v2/Getting-Started-First-Time-Git-Setup

ただ、これは PC のセットアップ時に限定されがちで、新規にプロジェクト参加時にも必要になるケースがあります。

### 名前とメールドレスが未設定の場合

この記事の執筆にあたり、改めて、名前とメールアドレスを未設定の状態でコミットしようとしたところそれはできないことがわかりました。コミット時に下記エラーになってコミットできませんでした。

```bash
Author identity unknown

*** Please tell me who you are.

Run

  git config --global user.email "you@example.com"
  git config --global user.name "Your Name"

to set your account's default identity.
Omit --global to set the identity only in this repository.

fatal: empty ident name (for <>) not allowed
```

そのため、名前が未設定な状態にはできなくて、検証リポジトリでは **Anonymous** という名前を設定してコミットしたため、 GitHub 上でも **Anonymous** と表示されています。無名だから **Anonymous** ではないです。

名前とメールアドレスを設定しても GitHub で関連付けされていないと、コミット時に指定した名前が表示されています。

メールアドレスを関連づけることでアカウントと紐づいて、この時点でコミット時の名前は表示されなくなります。

コード署名をしても GitHub に公開鍵が未登録だと Unverified のバッジが表示されます。

GitHub に公開鍵を登録すると Verified のバッジが表示されます。

## コミットに名前を設定する

まず名前の設定ですが、これが一番難しいかもしれません。

本名にするのか、ハンドルネームにするのか、名前の表記には特別なルールがなくて何を頼りに決めるのか迷うところです。

参加したプロジェクトに方針があれば、リポジトリごとに設定可能なので合わせるのが良いです。

会社名を含める書式で統一されたプロジェクトに参加したこともあります。

筆者の場合は、特に指定がない限り **KAWASHIMA Yoshiyuki** に統一しています

コミットに設定する名前はどんな時に役立つかというと、ローカル（ GitHub をホストとした時、手元の PC で確認すること）でコミットログを見る時、 IDE 上で Git Blame をした時などホストを介さないケースで表示されます。 

いずれの場合も表示領域としては狭いことが多いので、アルファベット表記よりも、漢字の方がわかりやすさは勝る気がします。

筆者が日本人の姓名のローマ字表記について拠り所としているものとして、下記のようなガイドラインがあります。

> 各府省庁が作成する公用文等において日本人の姓名をローマ字表記する際に，姓と
名を明確に区別させる必要がある場合には，姓を全て大文字とし（YAMADA Haruo），
「姓―名」の構造を示すこととする。

https://www.kantei.go.jp/jp/singi/seimei_romaji/pdf/moshiawase.pdf

> したがって，日本人の姓名については，ローマ字表記においても「姓－名」の順（例えばYamada Haruo）とすることが望ましい。なお，従来の慣習に基づく誤解を防くために，姓をすべて大文字とする（YAMADA Haruo），姓と名の間にコンマを打つ（Yamada,Haruo）などの方法で，「姓－名」の構造を示すことも考えられよう。

https://www.bunka.go.jp/kokugo_nihongo/sisaku/joho/joho/kakuki/22/tosin04/17.html

## コミットにメールアドレスを設定する

メールアドレスはシンプルです。

特定の組織に属してコミットする場合は、所属組織ドメインのメールアドレスを発行してもらえるので、そのメールアドレスを設定します。

前述の Git Setup にある通り、メールアドレスはリポジトリ単位で設定可能です。そのため、所属組織のリポジトリごとにメールアドレスを設定するなどして、複数の組織に所属する場合も個別に設定ができます。

## ホストにメールアドレスを登録する

コミットに設定されているメールアドレスで GitHub 上では同一アカウントか認識しているため、 Git に設定したメールアドレスを GitHub にも登録することで、コミットがアカウントと紐付いて表示されます。以降は、コミットに設定した名前が GitHub 上で表示されることはなくなって、アカウント名とそのアイコンが表示されるようになります。 GitHub 上でもメールアドレスは複数登録可能なので、複数の組織に所属するケースにも対応しています。

なお、 GitHub のアカウントを削除すると **ghost** という削除済みアカウントに変わるようです。

https://github.com/glideapps/quicktype/issues/1768

## コミットにコード署名する

名前とメールアドレスは他の人でも設定できてしまうため、コミットの一意性を担保するのは難しかったりします。とはいえ、 OSS と異なり、組織に所属することに一定の基準があれば、その組織内での活動においては事実上担保されます。

名前とメールアドレスに関連付けるキーを用意し、この秘密鍵でコミットにコード署名し、公開鍵をホストに登録して、一意性を担保しようとする試みになります。

## ホストに公開鍵を登録する

コード署名されたコミットの公開鍵がホスト側に未登録の場合、 GitHub では **Unverified** とバッジ表示されます。ホスト側に公開鍵を登録し、対になる秘密鍵でコード署名されたコミットに対して、 GitHub では **Verified** と表示されます。
おめでとうございます。
この段階で GitHub ではこのコミットが秘密鍵でコード署名されたものである、すなわち、秘密鍵を所持しているユーザ自身のものであると証明してくれています。

なお、キーに設定したメールアドレスとコミットのメールアドレスが一致していない場合も **Unverified** と表示されます。

## おわりに
ここまで読んでいただいてコミットの署名に対してその判断基準は得られたでしょうか
コミットは現代のプログラミングにおいてその変更履歴の最小単位になります。その単位に対して一意に作者を特定できる仕組みを活用したいと筆者は考えています。

直近で xz v5.6.0/5.6.1 にバックドアが仕込まれてしまう問題がありました。

https://github.com/orgs/Homebrew/discussions/5243

署名によって、この問題が直接的に回避できたかはあやしいですが、署名の仕組みを利用してコミットの安全性を測れるようになる未来も来るのではと考えています。

そのための準備としても、コミットにコード署名しておくことは有意義であると筆者は考えています。
